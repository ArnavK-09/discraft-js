import{debug}from"./logger.js";class CommandCache{constructor(options={}){this.cache=new Map;this.maxSize=options.maxSize||100;this.defaultTTL=options.ttl||6e4;this.maxMemoryMB=options.maxMemoryMB||50;this.commandSettings=new Map;this.startCleanupInterval()}get(commandName,args){const key=this.generateKey(commandName,args);const cached=this.cache.get(key);if(!cached){debug(`Cache miss for command: ${commandName}`);return null}if(Date.now()>cached.expiry){debug(`Cache entry expired for command: ${commandName}`);this.cache.delete(key);return null}debug(`Cache hit for command: ${commandName}`);return cached.value}set(commandName,args,value){const settings=this.commandSettings.get(commandName)||{ttl:this.defaultTTL};const estimatedSize=this.getObjectSize(value);if(this.getCurrentMemoryUsage()+estimatedSize>this.maxMemoryMB*1024*1024){debug(`Skipping cache due to memory limits: ${commandName}`);return false}if(this.cache.size>=this.maxSize){const oldestKey=this.cache.keys().next().value;this.cache.delete(oldestKey)}const key=this.generateKey(commandName,args);this.cache.set(key,{value:value,expiry:Date.now()+settings.ttl,size:estimatedSize});debug(`Cached result for command: ${commandName} (${estimatedSize} bytes)`);return true}setCommandSettings(commandName,settings){this.commandSettings.set(commandName,{ttl:settings.ttl||this.defaultTTL})}generateKey(commandName,args){const sortedArgs=args?JSON.stringify(args,Object.keys(args).sort()):"";return`${commandName}:${sortedArgs}`}cleanup(){const now=Date.now();for(const[key,value]of this.cache.entries()){if(now>value.expiry){this.cache.delete(key)}}}startCleanupInterval(){setInterval((()=>this.cleanup()),6e4)}getObjectSize(obj){const str=JSON.stringify(obj);return str.length*2}getCurrentMemoryUsage(){let total=0;for(const[_,value]of this.cache.entries()){total+=value.size}return total}getStats(){return{size:this.cache.size,maxSize:this.maxSize,memoryUsage:`${(this.getCurrentMemoryUsage()/(1024*1024)).toFixed(2)}MB`,maxMemory:`${this.maxMemoryMB}MB`}}}export const commandCache=new CommandCache({maxSize:200,ttl:12e4,maxMemoryMB:100});